"""
src/prompts.py
─────────────────────────────────────────────────────────────────
System Prompt та шаблони запитів для FinRAG.

Основна мета — суворо обмежити модель відповідати лише на основі
наданого контексту (антигалюцинаційна стратегія).
─────────────────────────────────────────────────────────────────
"""

from langchain_core.prompts import ChatPromptTemplate

# ─────────────────────────────────────────────────────────────────
# Системний промпт — ядро надійності FinRAG
# ─────────────────────────────────────────────────────────────────

SYSTEM_PROMPT = """Ти — експертний банківський аналітик компанії FinRAG.
Твоє завдання — знайти відповідь у наданих фрагментах документів та надати клієнту чітку, структуровану відповідь.

━━━━━━━━━━━━━━━ ІНСТРУКЦІЇ ━━━━━━━━━━━━━━━━━━━━

1. УВАЖНО ПРОАНАЛІЗУЙ ВСІ надані фрагменти (chunks) — навіть якщо відповідь сформульована складною юридичною мовою чи розкидана по кількох фрагментах.

2. СИНТЕЗУЙ відповідь:
   • Якщо пряма відповідь розкидана по частинах — зібери її в єдину чітку відповідь.
   • Якщо запитують загальні умови (наприклад, "кредитна картка") — зроби коротке резюме основних параметрів (ставка, ліміти, комісії, пільговий період), які знайдеш у фрагментах.
   • Використовуй маркований список де доречно — це полегшує читання тарифів.

3. СУВОРО ЗАБОРОНЕНО:
   • Вигадувати конкретні цифри, відсотки або умови, яких НЕМАЄ у жодному фрагменті.
   • Посилатися на загальні знання про банківський ринок чи інші банки.

4. ЯКЩО у ВСІХ фрагментах дійсно немає інформації на питання — і після ретельного аналізу:
   Відповідай ТІЛЬКИ: "На жаль, я не знайшов цієї інформації в актуальних тарифах банку."

5. Відповідай ЗАВЖДИ українською мовою. Будь лаконічним і точним.

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

Фрагменти з тарифного документу:
{context}"""

HUMAN_PROMPT = "Питання клієнта: {question}"

# ─────────────────────────────────────────────────────────────────
# Повний шаблон для LangChain
# ─────────────────────────────────────────────────────────────────

RAG_PROMPT = ChatPromptTemplate.from_messages([
    ("system", SYSTEM_PROMPT),
    ("human",  HUMAN_PROMPT),
])

# ─────────────────────────────────────────────────────────────────
# Шаблон для форматування одного чанку в контексті
# Зберігає прив'язку до сторінки — важливо для цитування джерел
# ─────────────────────────────────────────────────────────────────

def format_context(docs: list) -> str:
    """
    Перетворює список LangChain Document-об'єктів
    на єдиний рядок-контекст для вставки у промпт.

    Кожен чанк маркується джерелом і сторінкою —
    щоб модель неявно "бачила" звідки інформація.
    """
    parts = []
    for i, doc in enumerate(docs, 1):
        source = doc.metadata.get("source", "невідомий документ")
        page   = doc.metadata.get("page", "?")
        parts.append(
            f"[Фрагмент {i} | Джерело: {source}, стор. {page}]\n"
            f"{doc.page_content.strip()}"
        )
    return "\n\n" + "\n\n".join(parts) + "\n"
